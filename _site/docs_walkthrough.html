<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Basic installation</title>
    <meta name="description"
          content="OpenMapKitWebsite is the website for the OpenMapKit project. We are moving all training material within the wiki to the website
">

    <link rel="apple-touch-icon" sizes="57x57" href="../images/favicon/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="../images/favicon/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="../images/favicon/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="../images/favicon/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="../images/favicon/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="../images/favicon/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="../images/favicon/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="../images/favicon/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="../images/favicon/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="../images/favicon/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="../images/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="../images/favicon/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="../images/favicon/favicon-16x16.png">
<link rel="manifest" href="../images/favicon/manifest.json">
<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="..images/favicon/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">

    <link rel="stylesheet" href="css/foundation.css">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/fontello.css">
    <link rel="stylesheet" href="css/fonts.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/font-awesome.css">
    <link rel="stylesheet" href="css/home-nav.css">

    <script src="javascripts/libs.js" type="text/javascript"></script>
    <script >
        // terrificjs bootstrap
    (function ($) {
        $(document).ready(function () {
            var $page = $('body');
            var config = {
                dependencyPath: {
                    plugin: 'javascripts/'
                }
            }
            var application = new Tc.Application($page, config);
            application.registerModules();
            application.start();
        });
    })(Tc.$);
    </script>

    <script src="javascripts/masonry.pkgd.js" type="text/javascript"></script>
    <script src="javascripts/slick.min.js" type="text/javascript"></script>

</head>

<head>

    <!-- Styles -->
    <link rel="stylesheet" href="css/theDocs.all.min.css">
    <link rel="stylesheet" href="css/custom.css">
    <link rel="stylesheet" href="css/docs.css">

</head>


<body>

<div class='contain-to-grid sticky fixed'>
    <nav class='top-bar docs-nav-width' data-options='sticky_on: large' data-topbar=''>

        <ul class='title-area'>
            <li class='name'>
                <h1>
                    <a href='index.html'>
                        <div class="icn-logo_OMK"></div>
                    </a>
                </h1>
            </li>

            <li class="custom-topbar">
                <button type="button" class="custom-nav navbar-toggle for-sidebar" data-toggle="offcanvas">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            </li>

        </ul>
        <section class='top-bar-section'>
            <ul class="right">
                
                

                
                <li class="">
                    <a href="index.html">Home</a>
                </li>
                
                
                

                
                <li class="">
                    <a href="docs.html">Documentation</a>
                </li>
                
                
            </ul>
        </section>
    </nav>
</div>


<div role='main'>
    <div class="row">

    <!-- Sidebar -->
<aside id="new-sidebar">

    <div id="sideBar" class="new-sidebar-content">
        <ul class="">
        

        <li>
            <a href="index.html">Home</a>
            
            
        </li>

        

        <li>
            <a href="docs.html">Documentation</a>
            
            <ul class="open">
                
                <li class="" id="Users">
                    
                        <a href="#"> Users</a>
                    
                    <ul class="open">
                        
                        <li class="" id="Installation">
                            <a href="docs_install.html"> Installation</a>
                        </li>
                        
                        <li class="" id="Creating Forms">
                            <a href="docs_odkformsforomk.html"> Creating Forms</a>
                        </li>
                        
                        <li class="" id="Creating OSM Basemap">
                            <a href="docs_creatingbasemaps.html"> Creating OSM Basemap</a>
                        </li>
                        
                        <li class="" id="Additional Resources">
                            <a href="docs_additionalresources.html"> Additional Resources</a>
                        </li>
                        
                    </ul>
                </li>
                
                <li class="" id="Tutorials">
                    
                        <a href="#"> Tutorials</a>
                    
                    <ul class="open">
                        
                        <li class="" id="Walkthrough">
                            <a href="docs_walkthrough.html"> Walkthrough</a>
                        </li>
                        
                    </ul>
                </li>
                
                <li class="" id="Constraints">
                    
                        <a href="docs_constraints.html"> Constraints</a>
                    
                    <ul class="open">
                        
                    </ul>
                </li>
                
                <li class="" id="Developers">
                    
                        <a href="#"> Developers</a>
                    
                    <ul class="open">
                        
                        <li class="" id="Architecture">
                            <a href="docs_developers.html"> Architecture</a>
                        </li>
                        
                        <li class="" id="Technical Specs">
                            <a href="docs_developers.html"> Technical Specs</a>
                        </li>
                        
                        <li class="" id="Contributing Code">
                            <a href="docs_developers.html"> Contributing Code</a>
                        </li>
                        
                    </ul>
                </li>
                
            </ul>
            
        </li>

        

    </ul>
    </div>
</aside>
<!-- END Sidebar -->

<script type="text/javascript">

    jQuery(window).ready(function() {

        var pathname = window.location.pathname; // Returns path only
        $("#sideBar ul li a").each(function(){
            if (($(this).attr('href')) == pathname){
                $(this).addClass("activeMenu");
//                return false;
            }

        });

    });


</script>


    <article class="col-md-12 col-sm-12 main-content new-sidebar-main-padding" role="main">

        <section>
            <h2 id="openmapkit-walkthrough">OpenMapKit Walkthrough</h2>
<p>This walkthrough is intended to take you through the entire process of setting up and using OpenMapKit from start to finish.</p>

<p>The overview of the process is:</p>

<ol>
  <li>Build OpenMapKit Server</li>
  <li>Create and Add Survey</li>
  <li>Use HOT Export Tool to get OSM Data - basemap &amp; vector data (POSM Bundle)</li>
  <li>Deploy POSM Area of Interest with POSM Bundle</li>
  <li>Deploy Field Papers</li>
  <li>Deploy on Android</li>
  <li>View &amp; Download Survey Data</li>
  <li>Submit to OSM API</li>
</ol>

<h3 id="openmapkit-server-production-installation">OpenMapKit Server Production Installation</h3>

<p>For an actual deployment of OpenMapKit Server, it is recommended to use
<a href="https://github.com/AmericanRedCross/posm-build">posm-build</a> to install your
instance. posm-build is a lightweight shell build system used for POSM servers.
OpenMapKit Server is designed to be a part of a POSM server, however, the
posm-build allows you to be modular regarding what gets installed, so you can
and should use it if you want to install a standalone OpenMapKit Server.</p>

<p>The advantage is that in a few lines, you can have OpenMapKit Server installed
and integrated as an Upstart service in Ubuntu Linux. This means that if
OpenMapKit Server crashes or is restarted, the API will restart automatically.
Also, posm-build only gets the dependencies you need and downloads only the
files you need, so the entire repo does not need to be cloned with git.</p>

<p>Instructions for installing OpenMapKit Server on your development environment can be found <a href="https://github.com/AmericanRedCross/OpenMapKitServer/blob/master/docs/development-installation.md">here</a>.</p>

<h4 id="tested-on">Tested On</h4>

<ul>
  <li>Amazon EC2 Ubuntu Server 14.04 LTS
    <ul>
      <li>Instance Type: t2.nano</li>
      <li>vCPUs: 1</li>
      <li>Memory: 500 MB</li>
      <li>Storage: 8 GB</li>
      <li>Open Ports: 22, 80, 3210</li>
    </ul>
  </li>
</ul>

<p>OpenMapKit Server is intended to be as light-weight as possible, so you don’t
have to throw much hardware at it.</p>

<h4 id="steps">Steps</h4>

<ol>
  <li>
    <p>Download and extract posm-build.</p>

    <pre><code>         sudo -s
 wget -q -O - https://github.com/AmericanRedCross/posm-build/archive/master.tar.gz | tar -zxf - -C /root --strip=2
</code></pre>
  </li>
  <li>
    <p>Create a <code>settings.local</code> file in <code>/root/etc</code> with the following content:</p>

    <pre><code> posm_ip="54.191.109.128"
</code></pre>
  </li>
</ol>

<p>Replace the IP address for <code>posm_ip</code> with the actual public IP or your server. If you are on Amazon, this should be your Elastic IP.</p>

<ol>
  <li>
    <p>Execute <code>bootstrap.sh</code> and tell it to only install NGINX and OpenMapKit Server.</p>

    <pre><code> /root/scripts/bootstrap.sh base virt nodejs nginx omk
</code></pre>
  </li>
</ol>

<p>Let the installation churn. That’s it!</p>

<h4 id="upstart">Upstart</h4>

<p>You can start / stop / restart the <code>omk-service</code> like any Ubuntu Upstart service.</p>

<pre><code>sudo service omk-server stop
sudo service omk-server start
sudo service omk-server restart
</code></pre>

<h4 id="your-data">Your Data</h4>

<p>All of your data are stored in <code>/opt/omk/OpenMapKitServer/public</code>.</p>

<p>You can scp / sftp the</p>

<p>forms <code>/opt/omk/OpenMapKitServer/public/forms</code></p>

<p>deployments <code>/opt/omk/OpenMapKitServer/public/deployments</code></p>

<p>submissions <code>/opt/omk/OpenMapKitServer/public/submissions</code></p>

<p>from the server to backup and access your data. There is no database, so all of your data are in these files.</p>

<h3 id="creating-and-adding-a-survey">Creating and Adding a Survey</h3>

<h4 id="create-or-modify-xlsform-using-excel">Create or Modify XLSForm using Excel</h4>
<p>Creating forms for ODK or OMK can be as simple or complex as the survey itself. In most cases this step can be completed in under an hour.</p>

<p>Setting up the basic survey form:</p>

<table>
  <tbody>
    <tr>
      <td><img src="images/walkthrough/1.png" alt="" /></td>
    </tr>
  </tbody>
</table>

<p>Creating a drop down list of surveyor names:</p>

<table>
  <tbody>
    <tr>
      <td><img src="images/walkthrough/2.png" alt="" /></td>
    </tr>
  </tbody>
</table>

<p>Creating survey questions consistent with Open Street Map tags:
<img src="images/walkthrough/3.png" alt="" /> |</p>

<p>A similar example can be viewed and downloaded <a href="https://docs.google.com/spreadsheets/d/11H4-mGYTS61GLjSbVoTbmhoI5DjlF5fcBwNwQcvd2Go/edit#gid=0">here</a></p>

<p>More detailed documentation for how to correctly create a survey form can be found in the <a href="docs_odkformsforomk.html">Creating Surveys</a> tab in the <strong>Users</strong> documentation.</p>

<h4 id="upload-survey-to-openmapkit-server">Upload Survey to OpenMapKit Server</h4>

<p>To use the survey you create in the field, it must be added to OpenMapKit Server. You can upload forms by using the API call
<code>
http://{your_host_url}/pages/upload-form/
</code></p>

<p>OR</p>

<p>By opening OpenMapKit Server UI.</p>

<p>You will see all the forms currently on your server</p>

<p><img src="images/omkserver1.png" alt="OpenMapKit Server Forms" />
<em>OpenMapKit Server Forms</em></p>

<p>Clicking in the upper right corner will give you a drop down menu, click <strong>Upload Form</strong> to upload your survey.</p>

<p><img src="images/omkserver2.png" alt="OpenMapKit Server Upload Form" />
<em>Upload Form</em></p>

<p>You can drag-n-drop your form or click to select it. Then hit <strong>Submit</strong> to add your survey to your OpenMapKit Server.</p>

<h3 id="hot-export-tool---osm-basemap--data">HOT Export Tool - OSM Basemap &amp; Data</h3>

<p>The HOT Export Tool is used to get the larger Area of Interest data from OpenStreetMap onto the POSM. The two main components that it packages for you are 1) OSM PBF, the vector data,  and 2) MBTiles, basemap tiles.</p>

<p>POSM itself generates tiles, called <em>POSM Carto</em> on the device itself, but it is often useful to have the HOT Export Tool fetch tiles for you on the internet as well–especially if you want to have a satellite basemap.</p>

<p>Currently, the POSM HOT Export Tool can be reached at:</p>

<p><a href="http://export.posm.io/">http://export.posm.io/</a></p>

<p>Name and describe your export. On the right, make sure you have selected <em>Select Export Area</em>, and draw a bounding box to server as your Area of Interest.</p>

<p><img src="images/a-hot1.png" alt="Describe Export" />
<em>Describe an Export</em></p>

<p>Choose the file formats you want. You want to at least have OSM PBF. OSMAnd OBF is a bonus, because you can load your extract in OSMAnd. If you want the export tool to generate an MBTiles basemap from the internet, check <em>MBTiles</em>.</p>

<p><img src="images/a-hot2.png" alt="File Formats" />
<em>File Formats</em></p>

<p>If you would like to have an MBTiles basemap fetched from the internet <em>(optional)</em>, you need to specify the tile template URL and zoom levels to be fetched. This task by far takes the longest, and the generated MBTiles file can be <em>huge</em>… You can use <a href="http://tools.geofabrik.de/calc/">Geofabrik’s Tile Calculator</a> to help you determine how big your MBTiles is likely to be.</p>

<p><img src="images/a-hot3.png" alt="MBTiles Source URL" />
<em>MBTiles Source URL</em></p>

<p>Finally, you need to <strong>Create Export</strong>.</p>

<p><img src="images/a-hot4.png" alt="Export Details" />
<em>Export Details</em></p>

<p>The export begins by fetching OSM data from the Overpass API. This may take a while, and if you are creating  MBTiles, it may even take hours. You will be emailed when the export is complete.</p>

<p><img src="images/a-hot5.png" alt="Beginning of Export" />
<em>Beginning of Export</em></p>

<p>Once your export is completed, right click on <strong>POSM Bundle</strong> and copy the URL.</p>

<p><img src="images/a-hot6.png" alt="Completed Export" />
<em>Completed Export</em></p>

<h3 id="posm-area-of-interest-deployment">POSM Area of Interest Deployment</h3>

<p>The POSM needs to fetch the data generated by the HOT Export tool, load it’s databases, and setup it’s applications for the Area of Interest.</p>

<p>Make sure you are connected to the <strong>POSM</strong> wifi network. Then, connect to the POSM by going to:</p>

<p>http://posm.io</p>

<p>go to <strong>POSM ADMIN</strong>.</p>

<p>Paste the <strong>POSM Bundle</strong> url in the text area and <strong>START</strong>.</p>

<p><img src="images/b-aoi1.png" alt="Enter URL" />
<em>Enter URL</em></p>

<p>When the POSM Area of Interest (AOI) Deployment is complete, you will see a check box next to the task, and the console output will say <code>==&gt; tessera-fp-reset.js: END false</code>. This means that it is finished.</p>

<p><img src="images/b-aoi2.png" alt="Completed AOI" />
<em>Completed AOI</em></p>

<p>Now, let’s do a sanity check to see if the data has loaded correctly. Click on <strong>EDIT OPENSTREETMAP</strong> in the POSM Portal, or go to http://osm.posm.io</p>

<p>It may take a little while to start cutting tiles, but zoom out and zoom into the area that you loaded. You should see tiles being drawn.</p>

<p><img src="images/b-aoi3.png" alt="Tiles in OpenStreetMap" />
<em>POSM Carto Tiles in OpenStreetMap</em></p>

<p>Also check Field Papers.</p>

<p><img src="images/b-aoi4.png" alt="Tiles in Field Papers" />
<em>Tiles in Field Papers</em></p>

<h3 id="field-papers--openmapkit-atlas-deployment">Field Papers → OpenMapKit Atlas Deployment</h3>

<p>The deployments that you see in OpenMapKit are based off of the bounds of a Field Paper atlas. The entire Area of Interest is too large for the phone, so instead, our deployment is based off of a field paper atlas.</p>

<p>When you create a field paper, an atlas is generated, and we are using it’s slug for the <strong>name</strong>, the <strong>title</strong> for the title you gave the field paper, and the <strong>GeoJSON</strong> for drawing the bounds of each field paper page in OpenMapKit.</p>

<p><img src="images/fp.png" alt="Field Paper Explained" />
<em>Components of an Atlas</em></p>

<p>This step is soon to be automated, but now we manually enter the URL to the Atlas’s GeoJSON. This data encompasses the shapes that make up both the atlas as a whole as well as each page in the atlas. It also includes necessary metadata. We are using this data to generate a deployment for OpenMapKit. The name of the deployment is the <em>slug</em>, and the title is the title you gave the field paper.</p>

<p><img src="images/c-deploy1.png" alt="Enter URL" />
<em>Pasting Atlas GeoJSON URL</em></p>

<p>POSM is generating OSM XML from the API Database, POSM Carto MBTiles, and an extract of any other MBTiles included with the AOI.</p>

<p><img src="images/c-deploy2.png" alt="Progress" />
<em>Generating Field Papers OpenMapKit Deployment</em></p>

<p>When the deployment is complete, you should see <code>==&gt; gis_omk-posm-mbtiles.sh: END false</code>.</p>

<p><img src="images/c-deploy3.png" alt="Deployment Complete" />
<em>End of Script</em></p>

<p>You should also have all of the steps checked off.</p>

<p><img src="images/c-deploy4.png" alt="Check Marks" />
<em>Deployment Complete</em></p>

<h3 id="openmapkit-android---download-deployment">OpenMapKit Android - Download Deployment</h3>

<p>Now you are read to download a deployment on your phone. You can enter the server URL to your POSM, but scanning the QR Code on a field paper will also switch you to the correct URL of the POSM server. You can also manually enter the POSM Server’s URL. It is http://posm.io</p>

<p>Make sure your phone is connected to the <strong>POSM</strong> wifi network.</p>

<p class="imageSize"><img src="images/d-android1.png" alt="No Server Setup" /></p>

<p><em>No Server Setup Yet</em></p>

<p>The QR Code will be read, and it will bring you to the corresponding deployment.</p>

<p class="imageSize"><img src="images/d-android2.png" alt="Deployment Details" /></p>

<p><em>Deployment Details</em></p>

<p>Now you can download it by pressing the button in the lower right.</p>

<p class="imageSize"><img src="images/d-android3.png" alt="Downloading" /></p>

<p><em>Downloading</em></p>

<p>If you jump back to the previous screen, you can see the list of deployments on the POSM’s OpenMapKit Server.</p>

<p class="imageSize"><img src="images/d-android4.png" alt="List of Deployments" /></p>

<p><em>List of Deployments</em></p>

<p>Once your download is complete, there will be a new button in the bottom left to <strong>Check Out</strong> your deployment. This will turn on the POSM Carto MBTiles and OSM XML on the map for you.</p>

<p class="imageSize"><img src="images/d-android5.png" alt="Download Complete" /></p>

<p><em>Download Complete</em></p>

<p>You should also see the bounds of your field paper atlas pages. The top of the map should show the page that is green below.</p>

<p class="imageSize"><img src="images/d-android6.png" alt="Field Paper with Pages" /></p>

<p><em>Field Paper with Pages</em></p>

<h4 id="also">Also…</h4>

<p>Before, you always had to start with ODK Collect. Now, if you start from OpenMapKit and try to edit a feature, the app will lead you back to ODK Collect to fill in your survey.</p>

<p class="imageSize imageBorder"><img src="images/d-android7.png" alt="Notice to Launch ODK Collect" /></p>

<p><em>Notice to Launch ODK Collect</em></p>

<p>Once you’ve gotten back into OpenMapKit <em>from</em> ODK Collect, you can edit tags as usual.</p>

<p class="imageSize"><img src="images/d-android8.png" alt="Return from ODK Collect" /></p>

<h3 id="collect-data-using-surveys">Collect Data Using Surveys</h3>

<h5 id="start-blank-form-in-odk-collect">Start Blank form in ODK Collect</h5>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143725/e08011e8-e295-11e4-8df4-53db84657b5c.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143746/e10a4426-e295-11e4-857f-932854bfd6b1.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143734/e09dfb36-e295-11e4-85b5-c6f7d9107b3c.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143735/e0ab1320-e295-11e4-970a-2098b7d98b3c.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143736/e0ab7f90-e295-11e4-9835-6eedc6beda0e.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143737/e0ae9540-e295-11e4-8b4a-2a44d0e58618.png" alt="" /></p>

<h5 id="continue-form-in-openmapkit-android">Continue Form in OpenMapKit Android</h5>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143738/e0aff584-e295-11e4-9438-0490e06decfd.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143811/41619680-e296-11e4-94c7-6e6abbd6f1a9.png" alt="" /></p>

<p>You can click on any feature on your map to edit it.</p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143813/41672dac-e296-11e4-943c-a46cff5ec395.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143814/4167b812-e296-11e4-9301-52f662c61f94.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143816/416b2074-e296-11e4-9a77-87f3c998d6bc.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143818/41749b54-e296-11e4-80d3-9fd211ac7d3c.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143823/418bc694-e296-11e4-92c4-9acf989c95e9.png" alt="" /></p>

<h5 id="complete-form-in-odk-collect-app">Complete Form in ODK Collect App</h5>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143824/418dea64-e296-11e4-8939-3fc81b30facd.png" alt="" /></p>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143825/418fd0d6-e296-11e4-9e9e-1e9c4af0ac77.png" alt="" /></p>

<p>Click on <strong>Send Finalized Form(s)</strong> to get to the upload dialogue.</p>

<h5 id="upload-form-data-in-odk-collect-app">Upload Form Data in ODK Collect App</h5>

<p class="imageSize"><img src="https://cloud.githubusercontent.com/assets/506078/7143826/41946380-e296-11e4-9a4f-0c4ef0ed2e1e.png" alt="" /></p>

<p>Select all the forms you want or click <strong>Toggle All</strong>. When you’re read click <strong>Send Selected</strong> to upload your completed data to the server.</p>

<h4 id="view-form-data-on-openmapkit-server">View Form Data on OpenMapKit Server</h4>

<h5 id="see-your-odk--osm-submissions">See your ODK &amp; OSM submissions:</h5>
<p>Submissions can be viewed, downloaded and submitted to OSM from OMK Server. To access submitted forms and data, first open the OMK Server UI.</p>

<p><img src="images/omkserver1.png" alt="OpenMapKit Server Forms" />
<em>Forms</em></p>

<p>Click on the the <strong>View Submissions</strong> tab of the survey you would like to view.</p>

<p><img src="images/osm_submissions.png" alt="OpenMapKit View Submissions" />
<em>View Submissions</em></p>

<p>You have the options to view &amp; download the ODK data, view &amp; download the OSM data and the ability to submit the OSM data back to the OSM API.</p>

<p><img src="images/osm_metadata.png" alt="OpenMapKit Metadata" />
<em>Survey Metadata</em></p>

<p>If there are any conflicts that occur when submitting data back to the OSM API, the submission will fail. Conflicts will be flagged and have to be resolved manually using the <a href="https://github.com/AmericanRedCross/posm-replay-tool">POSM Changeset Replay Tool</a>.</p>

<h4 id="resolve-conflicts-with-the-posm-changeset-replay-tool">Resolve Conflicts with the POSM Changeset Replay Tool</h4>

<p>The Changeset Replay Tool is a workflow for resolving conflicts. It uses a local Git repository containing the current state (local edits), transform it so that it contains the new desired upstream state (what OSM should look like after merging), and apply the necessary transformations (in the form of API calls) to update the upstream state.</p>

<h5 id="obtain-aoi-extract-at-branch-point">1. Obtain AOI Extract at Branch Point</h5>

<p>You should already have a copy of this file.</p>

<h5 id="gather-local-changesets">2. Gather Local Changesets</h5>

<p>Determine the first local changeset. Assuming you have access to the local APIDB:</p>

<pre><code>psql -d osm_posm -t -c "select id from changesets where num_changes &gt; 0 order by id asc limit 1"
</code></pre>

<p>Gather changesets from the local OSM API into <code>changesets/</code>:</p>

<pre><code>OSM_BASE_URL=http://localhost:3000 ./gather_changesets.sh &lt;first changeset id&gt;
</code></pre>

<h5 id="initialize-the-git-repository-from-the-branch-point">3. Initialize the git Repository from the Branch Point</h5>

<p>Filter the AOI extract according to entities referenced in local changesets:</p>

<pre><code>node filter-by-use.js huaquillas-fixed.pbf posm/ changesets/*.osc
cd posm/
git init
git add .
git commit -m "Branch point"
git tag start
cd ..
</code></pre>

<h5 id="obtain-a-current-aoi-extract">4. Obtain a Current AOI Extract</h5>

<p>Calculate the bounding box for all local changesets and fetch the corresponding area from Overpass,
converting to PBF for good measure:</p>

<pre><code>echo "(node($(node changeset-bbox.js changesets/*.xml | jq -r 'map(tostring) | [.[1], .[0], .[3], .[2]] | join(",")'));&lt;;&gt;&gt;;&gt;;);out meta;" &gt; overpass.query
wget -O aoi.xml --post-file=overpass.query http://overpass-api.de/api/interpreter
osmconvert aoi.xml --out-pbf &gt; aoi.pbf
</code></pre>

<h5 id="extract-and-apply-upstream-changes">5. Extract and Apply Upstream Changes</h5>

<p>Filter the AOI extract according to entities referenced in local changesets and apply to a new
branch. This ensures that there’s a common ancestor when moving commits between branches.</p>

<pre><code>cd posm/
rm -rf *
cd ..

node filter-by-use.js aoi.pbf posm/ changesets/*.osc
cd posm/
git add .
git checkout -b osm
git commit -m "Current OSM"
git tag upstream
git gc
cd ..
</code></pre>

<h5 id="apply-local-changesets-to-the-branch-point">6. Apply Local Changesets to the Branch Point</h5>

<p>This is effectively what has already occurred through editing using the OSM API, although doing it in <code>git</code> terms allows us to more easily move changes between branches.</p>

<pre><code>cd posm/
git checkout master

REPO=posm ./preprocess-changesets.sh changesets/

cd posm/
git gc
cd ..
</code></pre>

<h5 id="apply-local-changesets-to-the-upstream-version-and-resolve-conflicts">7-8. Apply Local Changesets to the Upstream Version and Resolve Conflicts</h5>

<p>Walk through all local changesets and apply them to the upstream branch. This will open your
configured <code>git</code> mergetool (<code>opendiff</code> / FileMerge on OS X), allowing you to resolve conflicts
manually.</p>

<p>TODO extract this into a script</p>

<pre><code>cd posm/
git checkout osm
git tag marker start
git --no-pager log --reverse --format=%h marker..master | while read sha1; do
  git cherry-pick $sha1

  echo Applying $sha1

  if [ -f .git/CHERRY_PICK_HEAD ]; then
    # remove files that were deleted by us (as we no longer refer to them and
    # will submit the deletions as "if-unused")
    git status --porcelain | grep ^UD | cut -d " " -f 2 | xargs git rm

    # remove files that were deleted upstream
    git status --porcelain | grep ^DU | cut -d " " -f 2 | xargs git rm

    # data available to the mergetool:
    #  * OSM version
    #  * our version
    #  * current version of OSM refs (via API) -- (we don't know the version ref'd)
    #  * current version of our refs (via API, if POSM is available) -- (we don't know the version ref'd)

    # In other words, we can show node movements, tag and ref/membership changes
    # but not way/relation composition (visually)
    # TODO sometimes this fails, in which case marker will have already been set to $sha1
    git mergetool -y --no-prompt

    git clean -f

    git add */

    git commit --allow-empty -C $sha1
  fi

  # remove temporary files
  git clean -f

  # update the marker
  git tag -f marker $sha1
done
</code></pre>

<h5 id="submit-resolved-changesets-upstream">9. Submit Resolved Changesets Upstream</h5>

<p>Create a new branch for changesets that have been applied upstream and walk through all local
changesets, submitting them and renumbering (remapping entity IDs and references) as necessary.</p>

<pre><code>cd posm/
git checkout -b applied upstream
../submit-all.sh
</code></pre>

<p>ID remapping information will be left behind in <code>.git/map.json</code> (cumulative) and <code>.git/&lt;commit&gt;.json</code> (per-changeset).</p>

<p>To track the number of pending changesets, count the number of commits between the <code>upstream</code> marker and the tip of the <code>osm</code> branch:</p>

<pre><code>watch "git --no-pager log --reverse --format=%h upstream..osm | wc -l"
</code></pre>

<p>The Git repository we produced includes all of the history and context used for reconciliation. Once synchronization has been completed, its primary purpose is as an artifact of the merge process. Rather than partially applying upstream changes to POSM’s database, it’s much easier to replace all of the data with a new extract.</p>

        </section>

    </article>

</div>


</div>

<div id='footer'>
    <div class='row footer-spacing'>
        <div class='small-12 medium-12 large-12 column group'>
            <div class="row">
                <!-- ARC logo -->
                <div class="small-12 medium-3 large-2 column inline-flex logo-width">
                    <a class="logo" href='http://www.redcross.org' target="_blank">
                        <img src="images/logo_RC.png" class="footer-logo"/>
                    </a>
                </div>

                <!-- Social Media Links -->
                <div class="small-12 medium-3 large-2 column social-media">
                    <ul class='socials'>
                        <li class="pull-left">
                            <a href='https://twitter.com/openmapkit' target="_blank">
                                <i class='fa fa-twitter mini-icon'></i>
                            </a>
                        </li>
                        <li class="pull-left">
                            <a href='https://github.com/AmericanRedCross/OpenMapKitAndroid' target="_blank">
                                <i class='fa fa-github mini-icon'></i>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="small-6 column">

                    <div class="row">

                        <!-- Social Media Links -->
                        <div class="small-12 medium-12 large-12 column social-media-mobile">
                            <ul class='socials'>
                                <li class="pull-right">
                                    <a href='https://twitter.com/openmapkit' target="_blank">
                                        <i class='fa fa-twitter mini-icon'></i>
                                    </a>
                                </li>
                                <li class="pull-right">
                                    <a href='https://github.com/AmericanRedCross/OpenMapKitAndroid' target="_blank">
                                        <i class='fa fa-github mini-icon'></i>
                                    </a>
                                </li>
                            </ul>
                        </div>

                        <!-- License -->
                        <div class="small-12 medium-12 large-12 column license-align">
                            <a target="_blank" class="license pull-right" rel="license" href="http://creativecommons.org/licenses/by/4.0/">
                                <img alt="Creative Commons License" style="border-width:0" src="../images/ccby.svg"/>
                            </a>
                        </div>

                    </div>

                </div>

            </div>
        </div>
    </div>
</div>

<script src="javascripts/jquery.countTo.js" type="text/javascript"></script>
<script src="javascripts/jquery.appear.js" type="text/javascript"></script>
<script src="javascripts/jquery.validate.js" type="text/javascript"></script>
<script src="javascripts/jquery.sequence-min.js" type="text/javascript"></script>
<script src="javascripts/jquery.easing.1.3.js" type="text/javascript"></script>
<script src="javascripts/app.js" type="text/javascript"></script>
<script src="javascripts/jquery.min.js" type="text/javascript"></script>
<script src="javascripts/matchHeight.min.js" type="text/javascript"></script>
<script src="javascripts/clipboard.min.js" type="text/javascript"></script>
<script src="javascripts/jquery.fitvids.js" type="text/javascript"></script>
<script src="javascripts/bootstrap.min.js" type="text/javascript"></script>
<script src="javascripts/theDocs.js" type="text/javascript"></script>

<script src="javascripts/docs.js" type="text/javascript"></script>


</body>

</html>
